## Azure Portal
- the azure portal is a web console that can be used to manage Azure account and its resources.
- it's a GUI alternative to tools like PowerShell Modules and Azure CLI

## Default Permissions 
Normal users can have many interesting permissions in Entra ID 
- Read All users, Groups, Applications, Devices, Roles, Subscription and their public properties
- Invite Guests
- Create Security Groups 
- Read non-hidden Group memberships 
- add guests to owned groups 
- create new applications
- add up to 50 devices to azure

## MG Module
The MSGraph PowerShell module is an API wrapper for MSGraph API. It can be used to manage Entra ID and other Microsoft 365 services. Commands are autogenerated from Graph API. 
- MG module replaces Azure AD and MSOnline modules
- try to use AADGraph for enumeration as long as it's available.
- ` Install-Module Microsoft.Graph `
- Not Microsoft Graph CLI

To be able to use PowerShell module we must connect to MS Graph: 
- ` Connect-MgGraph`

We can also login using an access token: 
```
$Token = .....
Connect-MgGraph -AccessToken ($Token | ConvertToSecureString -ASPlaintext -Force)
```

Get the current session state: 
` Get-MgContext`

Get Details of current tenant: 
` Get-MgOrganization | fl *`

### Mg Module - Users 
Enumerate all users: 
`Get-MgUser -All`

Enumerate a specific user:
`Get-MgUser -UserId test@defcorphq.onmicrosoft.com`

Search for a user based on string in first characters of DisplayName or userPrinicpalName
- `Get-MgUser -All |?{$_.Displayname -match "admin"} `
- ` Get-MgUser -Search '"DisplayName:admin"' -ConsistencyLevel eventual`

List all attributes for a user: 
- ` Get-MgUser -UserId test@defcorphq.onmicrosoft.com | fl *`
- ` Get-MgUser -UserId test@defcorphq.onmicrosoft.com | %{_.PSObject.Propeties.name}

Search attributes for all users that contain the string "password":
- `Get-MgUser -All |%{$Properties = $_; $Properties.PSObject.Properties.Name | % {if($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}`

All users who are synced from on-prem
- ` Get-MgUser -All | ?{$_.OnpremisesSecurityIdentifier -ne $null} `

All Users who are from Entra Id
- ` Get-MgUser -All | ?{$_.OnpremisesSecurityIdentifier -eq $null}  `

Objects created by any user (use -ObjectId for a specific user)
- ` Get-MgUserCreatedObject -UserId test@defcorphq.onmicrosoft.com | fl * `

Object owned by a specific user: 
- ` Get-MgUserOwnedObject -UserId test@defcorphq.onmicrosoft.com | fl * `

### Mg Module - Groups
List all Groups: 
- ` Get-MgGroup -All `

Enumerate a specific group:
- ` Get-MgGroup -GroupId <id> `

Search for a group based on the first character of DisplayName (wildcard not supported)
- ` Get-MgGroup -ConsistencyLevel eventual -Search '"DisplayName:A"' `

Search groups with the word admin in their name: 
- ` Get-MgGroup -ConsistencyLevel eventual -Search '"DisplayName:Admin"' `

Get groups that allow Dynamic membership
- ` Get-MgGroup | ?{$_.GroupTypes -eq 'DynamicMembership} `

All groups that are synced from on-prem (note that security groups aren't synced)
- ` Get-MgGroup -All | ?{$_.OnPremisesSecurityIdentifier -ne $null} `

All Groups  that are from Entra Id:
- ` Get-MgGroup -All | ?{$_.OnPremisesSecurityIdentifier -eq $null} `

Default security Groups in AD: 
- `https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups#active-directory-default-security-groups-by-operating-system-version`

Get members of a group: 
- ` Get-MgGroupMember -GroupId <id> `

Get Groups and roles where the specified user is a member: 
- ` (Get-MgUserMemberOf -UserId test@defcorphq.onmicrosoft.com).AdditionalProperties `

### Mg Module - Roles
Get all available role template: 
- ` Get-MgDirectoryRoleTemplate `

Get all enabled roles(a built-in role must be enabled before usage)
- ` Get-MgDirectoryRole `

Enumerate users to whom roles are assigned: 
```
$RoleId = (Get-MgDirectoryRole -Filter "DisplayName eq 'Global Administrator'").Id

(Get-MgDirectoryRoleMember -DirectoryRoleId $RoleId).AdditionalProperties
```

### Mg Module - Devices
Get all Azure joined and registered devices: 
- ` Get-MgDevice -All | fl * `

List all the active devices: 
- ` Get-MgDevice -All | ?{$_.ApproximateLastSignInDateTime -ne $null} `

List registered owners of all devices:
```powershell
$Ids = (Get-MgDevice -All).Id; foreach($i in $Ids){ (Get-MgDeviceRegisteredOwner -DeviceId $i).AdditionalProperties}

$Ids = (Get-MgDevice -All).Id; foreach($i in $Ids){ (Get-MgDeviceRegisteredOwner -DeviceId $i).AdditionalProperties.userPrinicipalName}
```

List Registered user of all devices: 
```powershell
$Ids = (Get-MgDevice -All).Id; foreach($i in $Ids){ (Get-MgDeviceRegisteredUser -DeviceId $i).AdditionalProperties}

$Ids = (Get-MgDevice -All).Id; foreach($i in $Ids){ (Get-MgDeviceRegisteredUser -DeviceId $i).AdditionalProperties.userPrinicipalName}
```

List Devices by owned by user:
- ` (Get-MgUserOwnedDevice -userId test@defcorphq.onmicrosoft.com).AdditionalProperties `

List devices owned by a user: 
- ` (Get-MgUserRegisteredDevice -userId test@defcorphq.onmicrosoft.com).AdditionalProperties `

List Devices managed by Intune: 
- ` Get-MgDevice -All | ?{$_.IsCompliant -eq "True"} | fl * `

### Mg Module - Apps
- An Application object is a global representation of an App

Get all application objects registered with current tenant:
- ` Get-MgApplication -All `

Get all details about an application 
- ` Get-MgApplicationByAppId -AppId <id> | fl *`

Get an application based on the display name:
- ` Get-MgApplication -All | ?{$_.DisplayName -match "app"} `

The Get-MgApplication will show all the applications details including password but password value is not shown

List all Apps with an application password: 
- ` Get-MgApplication -All | ?{$_.PasswordCredentials -ne $null} `

Get Owner of application: 
- ` (Get-MgApplicationOwner -ApplicationId <id>).AdditionalProperties.userPrincipalName `

Get Apps where User has a role:
- ` Get-MgUserAppRoleAssignment -UserId test@defcorphq.onmicrosoft.com | fl * `

Get apps where group has role: 
- ` Get-MgGroupAppRolesAssignment -GroupId <id> | fl * `

### Mg Module - Service Principals 
- Service Principal is local representation for an app in a specific tenant and it'sthe security object that has privileges (Service Account)
- Service Principal are visible as Enterprise Application inn the Azure Portal
- Service Principals can be assigned Azure roles.

Get all Service Principal: 
- ` Get-MgServicePrincipal -All `

Get all details about a service principal: 
- ` Get-MgServicePrincipal -ServicePrincipalId <id>`

Get a service principal based on the display name:
- `  Get-MgServicePrincipal -All | ?{_.DisplayName -match "app"} `

Get a service principal with an applci
